<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoom L-20R - Discovery Mode</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #121212; color: #00ff00; padding: 20px; }
        .card { background: #1e1e1e; border: 2px solid #444; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        button { background: #28a745; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
        .log { background: black; color: #00ff00; text-align: left; padding: 10px; height: 300px; overflow-y: scroll; font-family: monospace; font-size: 13px; margin-top: 20px; border: 1px solid #444; }
        .service-item { background: #333; margin: 5px; padding: 10px; border-radius: 5px; font-size: 11px; color: #00d4ff; border-left: 3px solid #00d4ff; }
    </style>
</head>
<body>

    <div class="card">
        <h1>Zoom L-20R: שלב הגילוי</h1>
        <p>1. וודא שנורה מהבהבת במיקסר<br>2. לחץ על הכפתור ובחר ב-L-20R</p>
        <button id="scanBtn">התחבר וסרוק שירותים</button>
    </div>

    <div id="results" class="card" style="display:none;">
        <h3>שירותים שנמצאו:</h3>
        <div id="servicesList"></div>
    </div>

    <div class="log" id="log">לוג פעולות:</div>

    <script>
        const log = (msg) => {
            const div = document.getElementById('log');
            div.innerHTML += `> ${msg}<br>`;
            div.scrollTop = div.scrollHeight;
        };

        document.getElementById('scanBtn').onclick = async () => {
            try {
                log("פותח חלון בחירה...");
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    // אנחנו מבקשים מהדפדפן רשות לגשת לכל שירות אפשרי
                    optionalServices: [
                        '03b80100-f136-11e1-9103-0800200c9a66', // MIDI Standard
                        '00001800-0000-1000-8000-00805f9b34fb', // Generic Access
                        '00001801-0000-1000-8000-00805f9b34fb'  // Generic Attribute
                    ]
                });

                log("מתחבר ל-" + device.name + "...");
                const server = await device.gatt.connect();
                log("מחובר פיזית! (נורה אמורה להיות כחולה קבועה)");

                document.getElementById('results').style.display = 'block';
                const servicesList = document.getElementById('servicesList');
                servicesList.innerHTML = "";

                log("מחפש שירותים...");
                const services = await server.getPrimaryServices();
                log("נמצאו " + services.length + " שירותים.");

                for (const service of services) {
                    const item = document.createElement('div');
                    item.className = 'service-item';
                    item.innerText = "Service UUID: " + service.uuid;
                    servicesList.appendChild(item);
                    log("סורק מאפיינים לשירות: " + service.uuid.substring(0,8));
                    
                    try {
                        const chars = await service.getCharacteristics();
                        for (const char of chars) {
                            const cItem = document.createElement('div');
                            cItem.style.paddingRight = "20px";
                            cItem.style.color = "#fff";
                            cItem.innerText = "└ Characteristic: " + char.uuid;
                            servicesList.appendChild(cItem);
                        }
                    } catch (e) {
                        log("לא ניתן לקרוא מאפיינים לשירות זה.");
                    }
                }

            } catch (err) {
                log("שגיאה: " + err.message);
                console.error(err);
            }
        };
    </script>
</body>
</html>
